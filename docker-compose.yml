services:

  mediamtx:
    image: bluenviron/mediamtx:latest
    container_name: camera-rtsp-server
    restart: unless-stopped
    ports:
      - "8554:8554"     # RTSP port
      - "8888:8888"     # WebRTC port
      - "8889:8889"     # HLS port
    volumes:
      - ./mediamtx.yml:/mediamtx.yml
    networks:
      - camera-net

  camera-streamer:
    build: .
    container_name: camera-streamer
    restart: unless-stopped
    privileged: true
    devices:
      - /dev/video0:/dev/video0
      - /dev/video10:/dev/video10
      - /dev/video11:/dev/video11
      - /dev/video12:/dev/video12
      - /dev/video13:/dev/video13
      - /dev/video14:/dev/video14
      - /dev/video15:/dev/video15
      - /dev/video16:/dev/video16
      - /dev/media0:/dev/media0
      - /dev/media1:/dev/media1
      - /dev/media2:/dev/media2
      - /dev/media3:/dev/media3
    volumes:
      - /opt/vc:/opt/vc
      - /run/udev:/run/udev:ro
      - /usr/share/libcamera:/usr/share/libcamera:ro
    environment:
      - CAMERA_NAME=${CAMERA_NAME:-pi-camera}
      - RTSP_SERVER=${RTSP_SERVER:-mediamtx}
      - RTSP_PORT=${RTSP_PORT:-8554}
      - RESOLUTION=${RESOLUTION:-1280x720}
      - FRAMERATE=${FRAMERATE:-15}
      - BITRATE=${BITRATE:-2000000}
    depends_on:
      - mediamtx
    networks:
      - camera-net

networks:
  camera-net:
    driver: bridge
